#!/usr/bin/env bash

# ENV variables
LOG_FILE="/tmp/weather.log"
KINDLE_WEATHER_URL="http://your-server:port/kindle_image?gps_coordinates=38.58,-76.65"
FBINK_CMD="/mnt/us/usbnet/bin/fbink"
TMP_FILE="/tmp/kindle.tmp"
DISPLAY_FILE="/tmp/kindle.png"
DISABLE_SYS_UI_FLAG="/tmp/sys_ui_disabled"
DISABLE_WEATHER_FLAG="/mnt/us/disable-weather"
FULL_REFRESH_INTERVAL=5

debug() {
 local TIMESTAMP=$(date +%Y.%m.%d_%H:%M:%S)
 echo "$TIMESTAMP $1"
}

log() {
 local TIMESTAMP=$(date +%Y.%m.%d_%H:%M:%S)
 echo "$TIMESTAMP $1"
 echo "$TIMESTAMP $1" >> $LOG_FILE
}

is_valid_PNG() {
 local filepath=$1
 # Check if the file size is larger than 10KB
 local size=$(stat -c%s "$filepath" 2>/dev/null)
 if [ -f "$filepath" ] && [ "$size" -gt "10240" ]; then
  echo "true"
 else
  echo "false"
 fi
}
  
download_weather() {
 # Download the PNG to temp file
 debug "Downloading weather PNG from: $KINDLE_WEATHER_URL"
 wget -q -O "$TMP_FILE" "$KINDLE_WEATHER_URL"
 # Check if download succeeded
 if [ $? -eq 0 ] && [ $(is_valid_PNG $TMP_FILE) == "true" ]; then
  # Move temp file to the display file
  mv "$TMP_FILE" "$DISPLAY_FILE"
 else
  debug "Failed to download image."
 fi
}

full_refresh_counter=0
display_weather() {
 # Check if display file is valid
 if [ $(is_valid_PNG $DISPLAY_FILE) != "true" ]; then
  debug "Display image ($DISPLAY_FILE) is not valid."
  return
 fi

 if [ $full_refresh_counter -eq 0 ]; then
  debug "Display image: $DISPLAY_FILE (full refresh)"
  $FBINK_CMD -i "$DISPLAY_FILE" -f -q
 else
  debug "Display image: $DISPLAY_FILE"
  $FBINK_CMD -i "$DISPLAY_FILE" -q
 fi
 full_refresh_counter=$(( (full_refresh_counter + 1) % $FULL_REFRESH_INTERVAL ))
}

disable_native_ui() {
 if [ -f "$DISABLE_SYS_UI_FLAG" ]; then
  debug "Native UI alredy stopped, skipping..."
  return
 fi

 log "Disable screensaver."
 # Disable sleep
 /usr/bin/lipc-set-prop com.lab126.powerd preventScreenSaver 1

 log "Disable native UI."
 # Stop Kindle framework to disable status bar
 sleep 10
 /sbin/stop lab126_gui
 /sbin/stop framework
 /sbin/stop otaupd
 sleep 10

 # Set flag
 /bin/touch $DISABLE_SYS_UI_FLAG
}

enable_native_ui() {
 if [ ! -f "$DISABLE_SYS_UI_FLAG" ]; then
  debug "Native UI not stopped, skipping..."
  return
 fi

 log "Re-enable native UI and screensaver."

 # Start Kindle framework and native UI
 /sbin/start framework
 /sbin/start lab126_gui

 # Enable screen saver
 /usr/bin/lipc-set-prop com.lab126.powerd preventScreenSaver 0

 /bin/rm $DISABLE_SYS_UI_FLAG
}

check_stop_flag() {
 # If stop file is found, skip weather
 if [ -f "$DISABLE_WEATHER_FLAG" ]; then
  log "Disable weather script flag detected."
  enable_native_ui
  exit 0
 fi
}

check_stop_flag
disable_native_ui

while true; do
 download_weather
 display_weather
 debug "Sleep for 20 mintues."
 sleep 1200
 check_stop_flag
done
